# vim: set ft=dockerfile:
FROM quay.io/lvh-images/kernel-builder AS builder
ARG KERNEL_VER=5.4
COPY _data /data
WORKDIR /data
# NB: logrus sends everything to stderr it seems, so redirect it to stdout
RUN lvh kernels --dir . fetch     2>&1 ${KERNEL_VER}
RUN lvh kernels --dir . configure 2>&1 ${KERNEL_VER}
RUN lvh kernels --dir . build     2>&1 ${KERNEL_VER}

COPY scripts/generate-btf.sh /tmp/
RUN /tmp/generate-btf.sh /data/kernels/${KERNEL_VER}/tar-install

FROM busybox
ARG KERNEL_VER=5.4
COPY --from=builder /data/kernels/${KERNEL_VER}/tar-install /data/kernels/${KERNEL_VER}
