name: Image releases
on:
  push:
    branches:
      - main
    tags:
      - v*

# The idea here is we to reuse the images that we build during the PR phase. Since our builds are
# not reproducabe, this allow us to perform tests in the PR and ensure that everything works as
# expected when we do a release.
jobs:
  tag-images:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@96f53100ba2a5449eb71d2e6604bbcd94b9449b5 # v3.5.3
      - name: Getting image tag
        id: tag
        run: |
          echo tag=${GITHUB_REF##*/} | tee -a $GITHUB_OUTPUT
      - name: setup docker buildx
        uses: docker/setup-buildx-action@2a1a44ac4aa01993040736bd95bb470da1a38365 # v2.9.0
      - name: quay login
        uses: docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc # v2.2.0
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_ROBOT_TOKEN }}
      - name: tag images
        run: |
          name=${{ steps.tag.outputs.tag }}
          echo $name
          for f in $(find ./versions -type f ! -name README.md -printf "%P\n")
          do
              tag=$(cat ./versions/$f)
              image=$(echo $f/$tag | sed -e 's_/_:_; s_/_-_g')
              src_image="quay.io/lvh-images/$(echo $f/$tag | sed -e 's_/_:_; s_/_-_g')"
              dst_image=$(echo $src_image | sed -e "s/$tag/$name/")
              echo -e "\033[0;32m${src_image} -> ${dst_image}\e[0m";
              docker pull $src_image
              docker tag $src_image $dst_image
              docker push $dst_image
              docker image rmi $src_image $dst_image
          done
